
<!DOCTYPE html>


<html lang="en" data-content_root="../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />
    <link href="../_static/favicon-32x32.png" sizes="32x32" rel="icon" type="image/png">
    <link href="../_static/favicon-16x16.png" sizes="16x16" rel="icon" type="image/png">
    <title>xtl.autoproc &#8212; xtl 0.1.0dev0 documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=8f2a1f02" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="../_static/autodoc_pydantic.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../_static/documentation_options.js?v=a4c74b72"></script>
    <script src="../_static/doctools.js?v=9bcbadda"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'cli/xtl.autoproc';</script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="API documentation" href="../api/modules.html" />
    <link rel="prev" title="Command line utilities" href="index.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search..."
         aria-label="Search..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../index.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../_static/icon.png" class="logo__image only-light" alt="xtl 0.1.0dev0 documentation - Home"/>
    <script>document.write(`<img src="../_static/icon.png" class="logo__image only-dark" alt="xtl 0.1.0dev0 documentation - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../common/index.html">Shared utilities</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../common/options.html">Options</a></li>
<li class="toctree-l2"><a class="reference internal" href="../common/tables.html">Tables</a></li>
</ul>
</details></li>
<li class="toctree-l1 current active has-children"><a class="reference internal" href="index.html">Command line utilities</a><details open="open"><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="current">
<li class="toctree-l2 current active"><a class="current reference internal" href="#"><code class="docutils literal notranslate"><span class="pre">xtl.autoproc</span></code></a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../api/modules.html">API documentation</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="../api/xtl.html">xtl</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l3 has-children"><a class="reference internal" href="../api/xtl.common.html"><code class="docutils literal notranslate"><span class="pre">xtl.common</span></code> package</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/xtl.common.compatibility.html"><code class="docutils literal notranslate"><span class="pre">xtl.common.compatibility</span></code> module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/xtl.common.options.html"><code class="docutils literal notranslate"><span class="pre">xtl.common.options</span></code> module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/xtl.common.validators.html"><code class="docutils literal notranslate"><span class="pre">xtl.common.validators</span></code> module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/xtl.common.serializers.html"><code class="docutils literal notranslate"><span class="pre">xtl.common.serializers</span></code> module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/xtl.common.tables.html"><code class="docutils literal notranslate"><span class="pre">xtl.common.tables</span></code> module</a></li>
</ul>
</details></li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../api/xtl.config.html"><code class="docutils literal notranslate"><span class="pre">xtl.config</span></code> package</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/xtl.config.settings.html"><code class="docutils literal notranslate"><span class="pre">xtl.config.settings</span></code> module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/xtl.config.version.html"><code class="docutils literal notranslate"><span class="pre">xtl.config.version</span></code> module</a></li>
</ul>
</details></li>
</ul>
</details></li>
</ul>
</details></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../_sources/cli/xtl.autoproc.rst" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.rst</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>xtl.autoproc</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#prerequisites">Prerequisites</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#process-command"><code class="docutils literal notranslate"><span class="pre">process</span></code> command</a><ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#a-few-examples">A few examples</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#unit-cell-space-group">Unit-cell &amp; space group</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#reference-mtz-file">Reference MTZ file</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#resolution-cutoff">Resolution cutoff</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#anomalous-signal">Anomalous signal</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#ice-rings">Ice rings</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#beamline-macros">Beamline macros</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#dataset-merging">Dataset merging</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#output-directory">Output directory</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#parallelization">Parallelization</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#process-wf-command"><code class="docutils literal notranslate"><span class="pre">process_wf</span></code> command</a><ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#updating-nml-files">Updating NML files</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#options-command"><code class="docutils literal notranslate"><span class="pre">options</span></code> command</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#csv-specification">CSV specification</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#technical-documentation">Technical documentation</a><ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#dataset-discovery">Dataset discovery</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#dataset-name-determination">Dataset name determination</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#job-execution">Job execution</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#post-completion-tidy-up">Post-completion tidy-up</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#advanced-parametrization">Advanced parametrization</a></li>
</ul>
</li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section id="xtl-autoproc">
<h1><code class="docutils literal notranslate"><span class="pre">xtl.autoproc</span></code><a class="headerlink" href="#xtl-autoproc" title="Link to this heading">#</a></h1>
<p>The <code class="docutils literal notranslate"><span class="pre">xtl.autoproc</span></code> command is a wrapper around <a class="reference external" href="https://www.globalphasing.com/autoproc/">autoPROC</a> from Global
Phasing Ltd. This command helps in processing several datasets with autoPROC in batch mode, either with the same or
different parameters. In addition, it can also take care of loading the dependencies, setting up file permissions and
parsing the results, with minimum user intervention.</p>
<section id="prerequisites">
<h2>Prerequisites<a class="headerlink" href="#prerequisites" title="Link to this heading">#</a></h2>
<div class="admonition caution">
<p class="admonition-title">Caution</p>
<p><code class="docutils literal notranslate"><span class="pre">xtl.autoproc</span></code> is currently only tested and officially supported on Linux systems.</p>
</div>
<p>In order for <code class="docutils literal notranslate"><span class="pre">xtl.autoproc</span></code> to run, a working installation of autoPROC is required (instructions can be found
<a class="reference external" href="https://www.globalphasing.com/autoproc/manual/installation/">here</a>). This implies that all autoPROC dependencies are
also installed.</p>
<p>Once installed, the autoPROC <code class="docutils literal notranslate"><span class="pre">process</span></code> command should be discoverable in the system’s PATH. You can check this by
running the following command in your terminal:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>which<span class="w"> </span>process
</pre></div>
</div>
<p>If the above command returns a path, then you are good to go.</p>
<div class="admonition hint">
<p class="admonition-title">Hint</p>
<p>If autoPROC is not available on the system PATH, then <code class="docutils literal notranslate"><span class="pre">xtl.autoproc</span></code> can also leverage modules (<em>e.g.</em>
<a class="reference external" href="https://github.com/envmodules/modules">Environment Modules</a>) to load the required dependencies. Detailed
documentation will be provided in the future.</p>
</div>
</section>
<section id="process-command">
<h2><code class="docutils literal notranslate"><span class="pre">process</span></code> command<a class="headerlink" href="#process-command" title="Link to this heading">#</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">process</span></code> command is the main entry point for running autoPROC on multiple datasets. It takes as input a CSV file
containing paths to the first image of each dataset. In the simplest case, the command can be run as follows:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>xtl.autoproc<span class="w"> </span>process<span class="w"> </span>datasets.csv
</pre></div>
</div>
<p>where <code class="docutils literal notranslate"><span class="pre">datasets.csv</span></code> is a CSV file containing the paths the first image of each dataset to be processed, <em>i.e.</em></p>
<div class="literal-block-wrapper docutils container" id="id3">
<div class="code-block-caption"><span class="caption-text"><code class="docutils literal notranslate"><span class="pre">datasets.csv</span></code></span><a class="headerlink" href="#id3" title="Link to this code">#</a></div>
<div class="highlight-csv notranslate"><div class="highlight"><pre><span></span><span class="o"> # fist_image</span>
<span class="o"> /path/to/dataset1/dataset1_00001.cbf.gz</span>
<span class="o"> /path/to/dataset2/dataset2_00001.cbf.gz</span>
<span class="o"> /path/to/dataset3/dataset3_00001.cbf.gz</span>
<span class="o"> ...</span>
</pre></div>
</div>
</div>
<p>You will be prompted to confirm that the input parameters are correct.</p>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>Before proceeding <strong>take a moment to check the output paths</strong>. autoPROC jobs can generate hundreds of files and
directories that might be difficult or annoying to clean up if they are at the wrong location.</p>
</div>
<section id="a-few-examples">
<h3>A few examples<a class="headerlink" href="#a-few-examples" title="Link to this heading">#</a></h3>
<div class="admonition hint">
<p class="admonition-title">Hint</p>
<p>To print a detail list of all available options run:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>xtl.autoproc<span class="w"> </span>process<span class="w"> </span>--help
</pre></div>
</div>
</div>
<p>When options are provided directly to the <code class="docutils literal notranslate"><span class="pre">process</span></code> command, they will be applied to all datasets by default, unless
explicitly overridden in the CSV file. Some frequently used options are:</p>
<section id="unit-cell-space-group">
<h4>Unit-cell &amp; space group<a class="headerlink" href="#unit-cell-space-group" title="Link to this heading">#</a></h4>
<p>Specify starting unit-cell parameters and space group for indexing:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>xtl.autoproc<span class="w"> </span>process<span class="w"> </span>datasets.csv<span class="w"> </span>--unit-cell<span class="o">=</span><span class="s2">&quot;78 78 37 90 90 90&quot;</span><span class="w"> </span>--space-group<span class="o">=</span><span class="s2">&quot;P43212&quot;</span>
</pre></div>
</div>
</section>
<section id="reference-mtz-file">
<h4>Reference MTZ file<a class="headerlink" href="#reference-mtz-file" title="Link to this heading">#</a></h4>
<p>Specify a reference MTZ file to use for unit-cell parameters, space group and R-free flags:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>xtl.autoproc<span class="w"> </span>process<span class="w"> </span>datasets.csv<span class="w"> </span>--mtz-ref<span class="o">=</span><span class="s2">&quot;/path/to/reference.mtz&quot;</span>
</pre></div>
</div>
</section>
<section id="resolution-cutoff">
<h4>Resolution cutoff<a class="headerlink" href="#resolution-cutoff" title="Link to this heading">#</a></h4>
<p>Apply a resolution range cutoff:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>xtl.autoproc<span class="w"> </span>process<span class="w"> </span>datasets.csv<span class="w"> </span>--resolution<span class="o">=</span><span class="m">80</span>-1.2
<span class="gp">$ </span>xtl.autoproc<span class="w"> </span>process<span class="w"> </span>datasets.csv<span class="w"> </span>--resolution<span class="o">=</span><span class="m">80</span>-
<span class="gp">$ </span>xtl.autoproc<span class="w"> </span>process<span class="w"> </span>datasets.csv<span class="w"> </span>--resolution<span class="o">=</span><span class="m">1</span>.2
</pre></div>
</div>
<p>In the first case both a low and high resolution cutoff are applied, while in the other two only a low or high
resolution cutoff is applied, respectively.</p>
</section>
<section id="anomalous-signal">
<h4>Anomalous signal<a class="headerlink" href="#anomalous-signal" title="Link to this heading">#</a></h4>
<p>By default, <code class="docutils literal notranslate"><span class="pre">xtl.autoproc</span></code> will run autoPROC <code class="docutils literal notranslate"><span class="pre">process</span></code> with the <code class="docutils literal notranslate"><span class="pre">-ANO</span></code> flag, meaning that the Friedel pairs will
be kept separate. To enforce merging of Friedel pairs:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>xtl.autoproc<span class="w"> </span>process<span class="w"> </span>datasets.csv<span class="w"> </span>--no-anomalous
</pre></div>
</div>
</section>
<section id="ice-rings">
<h4>Ice rings<a class="headerlink" href="#ice-rings" title="Link to this heading">#</a></h4>
<p>autoPROC can automatically detect and exclude ice rings from the data. In case where the datasets are heavily
contaminated with ice, one can force the ice ring exclusion:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>xtl.autoproc<span class="w"> </span>process<span class="w"> </span>datasets.csv<span class="w"> </span>--exlude-ice
</pre></div>
</div>
<p>This option will set the following two autoPROC parameters to <code class="docutils literal notranslate"><span class="pre">True</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">XdsExcludeIceRingsAutomatically</span><span class="o">=</span><span class="n">yes</span>
<span class="n">RunIdxrefExcludeIceRingShells</span><span class="o">=</span><span class="n">yes</span>
</pre></div>
</div>
</section>
<section id="beamline-macros">
<h4>Beamline macros<a class="headerlink" href="#beamline-macros" title="Link to this heading">#</a></h4>
<p>Certain beamline-specific macros exist in autoPROC. These can be selected as follows:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>xtl.autoproc<span class="w"> </span>process<span class="w"> </span>datasets.csv<span class="w"> </span>--beamline<span class="o">=</span><span class="s2">&quot;PetraIIIP14&quot;</span>
</pre></div>
</div>
<p>This is equivalent to <code class="docutils literal notranslate"><span class="pre">-M</span> <span class="pre">PetraIIIP14</span></code> when running directly the autoPROC <code class="docutils literal notranslate"><span class="pre">process</span></code> command.</p>
<p>Note that the only beamline macro files can be passed with this mechanism and not any arbitrary macro. The list of
supported beamline macros can be found <em>via</em> <code class="docutils literal notranslate"><span class="pre">xtl.autoproc</span> <span class="pre">process</span> <span class="pre">--help</span></code>.</p>
</section>
<section id="dataset-merging">
<h4>Dataset merging<a class="headerlink" href="#dataset-merging" title="Link to this heading">#</a></h4>
<p>In case of incomplete data, or multiple sweeps of the same crystal, one can process multiple datasets in a single
autoPROC run and try to merge them, if they are compatible. In <code class="docutils literal notranslate"><span class="pre">xtl.autoproc</span></code> this can only be achieved by providing
a <code class="docutils literal notranslate"><span class="pre">group_id</span></code> column in the CSV file, <em>e.g.</em>:</p>
<div class="literal-block-wrapper docutils container" id="id4">
<div class="code-block-caption"><span class="caption-text"><code class="docutils literal notranslate"><span class="pre">datasets.csv</span></code></span><a class="headerlink" href="#id4" title="Link to this code">#</a></div>
<div class="highlight-csv notranslate"><div class="highlight"><pre><span></span><span class="o"># group_id</span><span class="p">,</span><span class="no">first_image</span>
<span class="o">1</span><span class="p">,</span><span class="no">/path/to/dataset1/dataset1_00001.cbf.gz</span>
<span class="o">2</span><span class="p">,</span><span class="no">/path/to/dataset2/dataset2_00001.cbf.gz</span>
<span class="o">2</span><span class="p">,</span><span class="no">/path/to/dataset3/dataset3_00002.cbf.gz</span>
</pre></div>
</div>
</div>
<p>In the above example, <code class="docutils literal notranslate"><span class="pre">dataset2_00001.cbf.gz</span></code> and <code class="docutils literal notranslate"><span class="pre">dataset3_00002.cbf.gz</span></code> will be merged into the same dataset,
since they have they same <code class="docutils literal notranslate"><span class="pre">group_id</span></code>. This option essentially passes multiple <code class="docutils literal notranslate"><span class="pre">-Id</span></code> flags to the autoPROC
<code class="docutils literal notranslate"><span class="pre">process</span></code> command (see <a class="reference external" href="http://www.globalphasing.com/autoproc/manual/autoPROC7.html#step5">Multi-sweep dataset processing</a>).</p>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p>See <a class="reference internal" href="#csv-specification">CSV specification</a> for more details on how to structure the input CSV file.</p>
</div>
</section>
<section id="output-directory">
<h4>Output directory<a class="headerlink" href="#output-directory" title="Link to this heading">#</a></h4>
<p>By default, the output of <code class="docutils literal notranslate"><span class="pre">xtl.autoproc</span> <span class="pre">process</span></code> will be saved in the current working directory. To specify a
different output directory:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>xtl.autoproc<span class="w"> </span>process<span class="w"> </span>datasets.csv<span class="w"> </span>--out-dir<span class="o">=</span><span class="s2">&quot;/path/to/output&quot;</span>
</pre></div>
</div>
<p>This will create subdirectories for each dataset in the specified output directory.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><code class="docutils literal notranslate"><span class="pre">xtl.autoproc</span></code> internally splits the input path to the first image into a <code class="docutils literal notranslate"><span class="pre">raw_data_dir</span></code>, <code class="docutils literal notranslate"><span class="pre">dataset_dir</span></code> and
<code class="docutils literal notranslate"><span class="pre">dataset_name</span></code> components, so that <code class="docutils literal notranslate"><span class="pre">first_image</span> <span class="pre">=</span> <span class="pre">{raw_data_dir}/{dataset_dir}/{dataset_name}_00001.ext</span></code>.
Therefore, the final output directory for each dataset will be <code class="docutils literal notranslate"><span class="pre">{output_dir}/{dataset_name}</span></code>. To further
understand the dataset discovery process, its gotchas and how to overcome them, read the <a class="reference internal" href="#dataset-discovery">Dataset discovery</a>
section.</p>
</div>
<p>A very common convention for diffraction data is to store the raw images and processed data in separate locations that
have a similar filestructure, <em>e.g.</em>:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>RAW_DATA:  /path/to/raw_data/datasets/dataset1/dataset1_00001.cbf.gz
PROCESSED: /path/to/processed/datasets/dataset1/
</pre></div>
</div>
<p>Here, the top level directory is different (<code class="docutils literal notranslate"><span class="pre">/path/to/raw_data</span></code> vs. <code class="docutils literal notranslate"><span class="pre">/path/to/processed</span></code>), but the file tree is the
same after some point (<code class="docutils literal notranslate"><span class="pre">datasets/dataset1/</span></code>). In this case, one can specify both <code class="docutils literal notranslate"><span class="pre">--raw-dir</span></code> and <code class="docutils literal notranslate"><span class="pre">--out-dir</span></code> to
influence the dataset discovery process and ensure that all output files will be saved in the correct subdirectory:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>xtl.autoproc<span class="w"> </span>process<span class="w"> </span>datasets.csv<span class="w"> </span>--raw-dir<span class="o">=</span><span class="s2">&quot;/path/to/raw_data&quot;</span><span class="w"> </span>--out-dir<span class="o">=</span><span class="s2">&quot;/path/to/processed&quot;</span>
</pre></div>
</div>
<p>If we run the above command with the following CSV file:</p>
<div class="literal-block-wrapper docutils container" id="id5">
<div class="code-block-caption"><span class="caption-text"><code class="docutils literal notranslate"><span class="pre">datasets.csv</span></code></span><a class="headerlink" href="#id5" title="Link to this code">#</a></div>
<div class="highlight-csv notranslate"><div class="highlight"><pre><span></span><span class="o"># first_image</span>
<span class="o">/path/to/raw_data/datasets/dataset1/dataset1_00001.cbf.gz</span>
<span class="o">/path/to/raw_data/datasets/dataset2/dataset2_00001.cbf.gz</span>
<span class="o">/path/to/raw_data/datasets/dataset3/dataset3_00001.cbf.gz</span>
</pre></div>
</div>
</div>
<p>then the output directories will be <code class="docutils literal notranslate"><span class="pre">/path/to/processed/datasets/datasetX</span></code>.</p>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p>See the <a class="reference internal" href="#dataset-discovery">Dataset discovery</a> section for more details.</p>
</div>
</section>
<section id="parallelization">
<h4>Parallelization<a class="headerlink" href="#parallelization" title="Link to this heading">#</a></h4>
<p>By default, <code class="docutils literal notranslate"><span class="pre">xtl.autoproc</span> <span class="pre">process</span></code> will wait until each dataset has finished processing before starting the next one.
However, if the system has adequate resources (<em>e.g.</em> in a high-performance cluster), one can perform multiple autoPROC
jobs in parallel:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>xtl.autoproc<span class="w"> </span>process<span class="w"> </span>datasets.csv<span class="w"> </span>--no-jobs<span class="o">=</span><span class="m">2</span>
</pre></div>
</div>
<div class="admonition danger">
<p class="admonition-title">Danger</p>
<p>Be careful when running multiple jobs in parallel, as autoPROC can be quite resource-intensive. It is recommended to
monitor the system’s resources during the run to determine the optimal number of parallel jobs.</p>
</div>
<p>Additionally, one can also specify the number of XDS jobs and processors for each autoPROC run, using:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>xtl.autoproc<span class="w"> </span>process<span class="w"> </span>datasets.csv<span class="w"> </span>--xds-jobs<span class="o">=</span><span class="m">4</span><span class="w"> </span>--xds-proc<span class="o">=</span><span class="m">8</span>
</pre></div>
</div>
<p>This essentially sets the following two autoPROC parameters:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">autoPROC_XdsKeyword_MAXIMUM_NUMBER_OF_JOBS</span><span class="o">=</span><span class="mi">4</span>
<span class="n">autoPROC_XdsKeyword_MAXIMUM_NUMBER_OF_PROCESSORS</span><span class="o">=</span><span class="mi">8</span>
</pre></div>
</div>
</section>
</section>
</section>
<section id="process-wf-command">
<h2><code class="docutils literal notranslate"><span class="pre">process_wf</span></code> command<a class="headerlink" href="#process-wf-command" title="Link to this heading">#</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">process_wf</span></code> command is a variation of the <code class="docutils literal notranslate"><span class="pre">process</span></code> command, intended to process datasets that have been
collected using the Global Phasing workflow, available at certain synchrotrons. When collecting data with the GPhL
workflow, a <code class="docutils literal notranslate"><span class="pre">stratcal_gen.nml</span></code> file is generated, containing information about the different sweeps, how they are
related to each other, <em>etc</em>, but most importantly (at least for <code class="docutils literal notranslate"><span class="pre">xtl.autoproc</span></code>), the paths to the images.</p>
<p>While these data can be merged manually (see: <a class="reference internal" href="#dataset-merging">Dataset merging</a>), it is recommended to make use of
the information available in the <code class="docutils literal notranslate"><span class="pre">stratcal_gen.nml</span></code> file. Typically, one would run the autoPROC <code class="docutils literal notranslate"><span class="pre">process_wf</span></code> command
instead, providing the NML file as input. The <code class="docutils literal notranslate"><span class="pre">xtl.autoproc</span> <span class="pre">process_wf</span></code> does exactly that, but also enables queuing
multiple runs with the use of a CSV file, similar to the <code class="docutils literal notranslate"><span class="pre">xtl.autoproc</span> <span class="pre">process</span></code> command.</p>
<p>The typical usage of the <code class="docutils literal notranslate"><span class="pre">xtl.autoproc</span> <span class="pre">process_wf</span></code> command is as follows:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>xtl.autoproc<span class="w"> </span>process_wf<span class="w"> </span>datasets.csv
</pre></div>
</div>
<p>where <code class="docutils literal notranslate"><span class="pre">datasets.csv</span></code> now contains a list of paths to NML files, instead of first images, <em>e.g.</em>:</p>
<div class="literal-block-wrapper docutils container" id="id6">
<div class="code-block-caption"><span class="caption-text"><code class="docutils literal notranslate"><span class="pre">datasets.csv</span></code></span><a class="headerlink" href="#id6" title="Link to this code">#</a></div>
<div class="highlight-csv notranslate"><div class="highlight"><pre><span></span><span class="o"># nml_file</span>
<span class="o">/path/to/dataset1/stratcal_gen.nml</span>
<span class="o">/path/to/dataset2/stratcal_gen.nml</span>
<span class="o">/path/to/dataset3/stratcal_gen.nml</span>
</pre></div>
</div>
</div>
<p>Although additional options can be passed along using the CSV file, do note that the NML files already contain
information about unit-cell, space group, relative crystal orientation between sweeps, <em>etc</em>.</p>
<section id="updating-nml-files">
<h3>Updating NML files<a class="headerlink" href="#updating-nml-files" title="Link to this heading">#</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">stratcal_gen.nml</span></code> files are generated during data collection at the synchrotron. This means that the paths to the
collected images will follow the file structure of the light source. If the data have been transferred to a different
location (<em>e.g.</em> a local drive), then all the paths in the NML file would be invalid. However, the NML file still
contains valuable information and should be the preferred way of processing GPhL workflow data.</p>
<p>In order to update the image directories within an NML file, a simple command is provided:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>xtl.autoproc<span class="w"> </span>fixnml<span class="w"> </span>stratcal_gen.nml<span class="w"> </span>--from<span class="o">=</span><span class="s2">&quot;/synchrotron/path/to/raw_data&quot;</span><span class="w"> </span>--to<span class="o">=</span><span class="s2">&quot;/local/path/to/raw_data&quot;</span><span class="w"> </span>--check
</pre></div>
</div>
<p>This will read the <code class="docutils literal notranslate"><span class="pre">stratcal_gen.nml</span></code> file, and update the <code class="docutils literal notranslate"><span class="pre">NAME_TEMPLATE</span></code> for each sweep, by replacing the
value of <code class="docutils literal notranslate"><span class="pre">--from</span></code> with the value of <code class="docutils literal notranslate"><span class="pre">--to</span></code>. For example, if the NML file contains:</p>
<div class="literal-block-wrapper docutils container" id="id7">
<div class="code-block-caption"><span class="caption-text"><code class="docutils literal notranslate"><span class="pre">stratcal_gen.nml</span></code></span><a class="headerlink" href="#id7" title="Link to this code">#</a></div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&amp;</span><span class="n">SIMCAL_SWEEP_LIST</span>
    <span class="n">NAME_TEMPLATE</span> <span class="o">=</span> <span class="s1">&#39;/synchrotron/path/to/raw_data/datasets/dataset1/dataset1_####.cbf.gz&#39;</span>
</pre></div>
</div>
</div>
<p>then a <code class="docutils literal notranslate"><span class="pre">stratcal_gen_updated.nml</span></code> file will be created with:</p>
<div class="literal-block-wrapper docutils container" id="id8">
<div class="code-block-caption"><span class="caption-text"><code class="docutils literal notranslate"><span class="pre">stratcal_gen_updated.nml</span></code></span><a class="headerlink" href="#id8" title="Link to this code">#</a></div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&amp;</span><span class="n">SIMCAL_SWEEP_LIST</span>
    <span class="n">NAME_TEMPLATE</span> <span class="o">=</span> <span class="s1">&#39;/local/path/to/raw_data/datasets/dataset1/dataset1_####.cbf.gz&#39;</span>
</pre></div>
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">--check</span></code> flag will perform a GLOB search for <code class="docutils literal notranslate"><span class="pre">dataset1_*.cbf.gz</span></code> within the new directory, <em>i.e.</em>
<code class="docutils literal notranslate"><span class="pre">/local/path/to/raw_data/datasets/dataset1/</span></code>, and if no files match that pattern, the user will be notified.</p>
<p>Multiple NML files can be updated at once, by providing a list of them as arguments to the command. At the end, an
<code class="docutils literal notranslate"><span class="pre">updated_nml.csv</span></code> file will be saved in the current working directory, which will contain the absolute paths to the
updated NML files and can be passed directly to <code class="docutils literal notranslate"><span class="pre">xtl.autoproc</span> <span class="pre">process_wf</span></code>.</p>
</section>
</section>
<section id="options-command">
<span id="id1"></span><h2><code class="docutils literal notranslate"><span class="pre">options</span></code> command<a class="headerlink" href="#options-command" title="Link to this heading">#</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">options</span></code> command prints a table of all supported options for dataset discovery and autoPROC configuration that
can be parsed from the CSV file.</p>
</section>
<section id="csv-specification">
<h2>CSV specification<a class="headerlink" href="#csv-specification" title="Link to this heading">#</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">datasets.csv</span></code> file is a powerful way to fully customize the autoPROC runs on a per-dataset basis. Various options
influencing the dataset discovery or autoPROC configuration can be passed along.</p>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p>See the <a class="reference internal" href="#options-command"><span class="std std-ref">options command</span></a> for more details on the available options.</p>
</div>
<p>When preparing the input CSV file, a few rules should be followed:</p>
<ol class="arabic simple">
<li><p>The first line should start with <code class="docutils literal notranslate"><span class="pre">#</span></code> followed by a space, and then comma-separated list of column names (without
spaces). The order of the columns is not important.</p></li>
<li><p>If an unknown column is found in the header, it will be ignored.</p></li>
<li><p>Any subsequent lines starting with <code class="docutils literal notranslate"><span class="pre">#</span></code> will be treated as comments and ignored.</p></li>
<li><p>Each line should contain values for one dataset, in the same order as in the header.</p></li>
<li><p>Each line should contain the same number of values as the header, but one or more of them can be empty.</p></li>
<li><p>Each line should be terminated with a newline character.</p></li>
<li><p>Spaces in values will not be trimmed!</p></li>
</ol>
<p>Taking all the above into account, a more complex CSV file might look like this:</p>
<div class="literal-block-wrapper docutils container" id="id9">
<div class="code-block-caption"><span class="caption-text"><code class="docutils literal notranslate"><span class="pre">datasets.csv</span></code></span><a class="headerlink" href="#id9" title="Link to this code">#</a></div>
<div class="highlight-csv notranslate"><div class="highlight"><pre><span></span><span class="o"># first_image</span><span class="p">,</span><span class="no">unit_cell</span><span class="p">,</span><span class="kd">space_group</span><span class="p">,</span><span class="m">reference_mtz</span><span class="p">,</span><span class="s1">beamline</span>
<span class="o">/path/to/dataset1/dataset1_00001.cbf.gz</span><span class="p">,</span><span class="no">78;78;37;90;90;90</span><span class="p">,</span><span class="kd">P 43 21 2</span><span class="p">,,</span>
<span class="o">/path/to/dataset2/dataset2_00002.cbf.gz</span><span class="p">,,,</span><span class="m">/path/to/reference.mtz</span><span class="p">,</span>
<span class="o">/path/to/dataset3/dataset3_00003.cbf.gz</span><span class="p">,,,,</span><span class="s1">PetraIIIP14</span>
</pre></div>
</div>
</div>
<p>This will run the first dataset with the specified space group and unit-cell, the second dataset with a reference MTZ
file and the last one with the <code class="docutils literal notranslate"><span class="pre">PetraIIIP14</span></code> macro file. Notice that each line contains the same number of commas,
meaning that they all have the same number of columns. Also note that the <code class="docutils literal notranslate"><span class="pre">unit_cell</span></code> parameter is provided as a
semicolon-separated list of values.</p>
<p>Any dataset-specific options specified on the CSV file will first be merged with the global options passed along the
<code class="docutils literal notranslate"><span class="pre">xtl.autoproc</span> <span class="pre">process</span></code> command,. If an option is specified both on a global and a dataset level, then the dataset one
will take precedence. For example, running the above CSV file with:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>xtl.autoproc<span class="w"> </span>process<span class="w"> </span>datasets.csv<span class="w"> </span>--space-group<span class="o">=</span><span class="s2">&quot;P 21&quot;</span>
</pre></div>
</div>
<p>then the first dataset will be processed with space group <span class="math notranslate nohighlight">\(P 4_3 2_1 2\)</span>, while the rest with <span class="math notranslate nohighlight">\(P 2_1\)</span>.</p>
<p>One can easily image the flexibility for fully customized runs that is provided with this architecture.</p>
</section>
<section id="technical-documentation">
<h2>Technical documentation<a class="headerlink" href="#technical-documentation" title="Link to this heading">#</a></h2>
<section id="dataset-discovery">
<h3>Dataset discovery<a class="headerlink" href="#dataset-discovery" title="Link to this heading">#</a></h3>
<p>The dataset discovery process is a crucial part of <code class="docutils literal notranslate"><span class="pre">xtl.autoproc</span></code> as it determines the output directories for each
autoPROC run. When provided with an absolute path to the first image, <code class="docutils literal notranslate"><span class="pre">xtl.autoproc</span></code> tries to extract three values
from that path: <code class="docutils literal notranslate"><span class="pre">raw_data_dir</span></code>, <code class="docutils literal notranslate"><span class="pre">dataset_dir</span></code> and <code class="docutils literal notranslate"><span class="pre">dataset_name</span></code>. The <code class="docutils literal notranslate"><span class="pre">dataset_dir</span></code> is particularly important,
because the same value will be used to determine the output path, <em>i.e.</em> <code class="docutils literal notranslate"><span class="pre">{output_dir}/{dataset_dir}</span></code>.</p>
<p>Let’s consider the following example:</p>
<div class="literal-block-wrapper docutils container" id="id10">
<div class="code-block-caption"><span class="caption-text"><code class="docutils literal notranslate"><span class="pre">datasets.csv</span></code></span><a class="headerlink" href="#id10" title="Link to this code">#</a></div>
<div class="highlight-csv notranslate"><div class="highlight"><pre><span></span><span class="o"># first_image</span>
<span class="o">/path/to/raw_data/datasets/dataset1/dataset1_measurement1_00001.cbf.gz</span>
</pre></div>
</div>
</div>
<p>When no additional information is provided, the <code class="docutils literal notranslate"><span class="pre">dataset_dir</span></code> is assumed to be the parent directory of the first
image, and everything preceding that will be the <code class="docutils literal notranslate"><span class="pre">raw_data_dir</span></code>, <em>i.e.</em>:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>/path/to/raw_data/datasets/dataset1/dataset1_measurement1_00001.cbf.gz
\________________________/ \______/ \___________________/
       raw_data_dir       dataset_dir    dataset_name
</pre></div>
</div>
<p>In this case, the output directory for the dataset will be <code class="docutils literal notranslate"><span class="pre">{output_dir}/dataset1</span></code>, where <code class="docutils literal notranslate"><span class="pre">output_dir</span></code> can be
specified using the <code class="docutils literal notranslate"><span class="pre">--out-dir</span></code> option (default: current working directory).</p>
<p>However, the discovery process can be influenced by providing a raw data directory, either globally with the
<code class="docutils literal notranslate"><span class="pre">--raw-dir</span></code> option or on a per-dataset basis with the <code class="docutils literal notranslate"><span class="pre">raw_data_dir</span></code> parameter on the CSV file (see:
<a class="reference internal" href="#csv-specification">CSV specification</a>). If, for example, the user specifies <code class="docutils literal notranslate"><span class="pre">--raw-dir=&quot;/path/to/raw_data&quot;</span></code>, then the same path will be
split as follows:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>/path/to/raw_data/datasets/dataset1/dataset1_measurement1_00001.cbf.gz
\_______________/ \_______________/ \___________________/
   raw_data_dir      dataset_dir         dataset_name
</pre></div>
</div>
<p>and the output directory for the dataset will be <code class="docutils literal notranslate"><span class="pre">{output_dir}/datasets/dataset1</span></code>.</p>
<p>Optionally, one can specify subsequent subdirectories within the above location with the <code class="docutils literal notranslate"><span class="pre">--out-subdir</span></code> flag or
<code class="docutils literal notranslate"><span class="pre">output_subdir</span></code> column in the CSV file. For example, setting <code class="docutils literal notranslate"><span class="pre">--out-subdir=my/output</span></code> will put the output of
autoPROC in <code class="docutils literal notranslate"><span class="pre">{output_dir}/datasets/dataset1/my/output</span></code>.</p>
<section id="dataset-name-determination">
<h4>Dataset name determination<a class="headerlink" href="#dataset-name-determination" title="Link to this heading">#</a></h4>
<p>In order to explicitly instruct autoPROC to process a specific dataset, <code class="docutils literal notranslate"><span class="pre">xtl.autoproc</span></code> constructs a <code class="docutils literal notranslate"><span class="pre">-Id</span></code> flag,
which is in the form of:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>-Id xtl1234,/path/to/raw_data/datasets/dataset1/,dataset1_measurement1_0####.cbf.gz,1,3600
    \_____/ \_________________________________/ \_________________________________/ | \__/
    sweep_id          image_directory                      image_template           |  last_image_no
                                                                                    first_image_no
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">sweep_id</span></code> is a unique alphanumeric identifier (irrelevant for the user), <code class="docutils literal notranslate"><span class="pre">image_directory</span></code> is set to
<code class="docutils literal notranslate"><span class="pre">{raw_data_dir}/{dataset_dir}/</span></code>, while <code class="docutils literal notranslate"><span class="pre">image_template</span></code>, <code class="docutils literal notranslate"><span class="pre">first_image_no</span></code> and <code class="docutils literal notranslate"><span class="pre">last_image_no</span></code> are required
for <code class="docutils literal notranslate"><span class="pre">XDS.INP</span></code>. The part of the <code class="docutils literal notranslate"><span class="pre">image_template</span></code> preceding the <code class="docutils literal notranslate"><span class="pre">#</span></code> characters is called <code class="docutils literal notranslate"><span class="pre">dataset_name</span></code> within
<code class="docutils literal notranslate"><span class="pre">xtl.autoproc</span></code>.</p>
<p>Essentially, the <code class="docutils literal notranslate"><span class="pre">dataset_name</span></code> is the part of the image filename preceding the image number
(<code class="docutils literal notranslate"><span class="pre">dataset1_measurement1</span></code> in the above example). To determine that value, a GLOB search is performed within
the dataset directory, the results are sorted alphabetically, and a character-by-character comparison is performed
between the first and last result, <em>i.e.</em> the first and last image (hopefully). Then <code class="docutils literal notranslate"><span class="pre">dataset_name</span></code> is set to the
longest common substring between the two files, <em>e.g.</em> <code class="docutils literal notranslate"><span class="pre">dataset1_measurement1_0</span></code> if the first and last images are
<code class="docutils literal notranslate"><span class="pre">dataset1_measurement1_00001.cbf.gz</span></code> and <code class="docutils literal notranslate"><span class="pre">dataset1_measurement1_03600.cbf.gz</span></code>.</p>
<p>In practice, there are a few more tricks in place to ensure that the dataset name determination is robust enough,
although it can never be foolproof. In case of atypical naming conventions, the automatic dataset name determination
might fail. In such cases, one can explicitly define all the above parameters in the CSV file, <em>e.g.</em>:</p>
<div class="literal-block-wrapper docutils container" id="id11">
<div class="code-block-caption"><span class="caption-text"><code class="docutils literal notranslate"><span class="pre">datasets.csv</span></code></span><a class="headerlink" href="#id11" title="Link to this code">#</a></div>
<div class="highlight-csv notranslate"><div class="highlight"><pre><span></span><span class="o"># raw_data_dir</span><span class="p">,</span><span class="no">dataset_dir</span><span class="p">,</span><span class="kd">dataset_name</span>
<span class="o">/path/to/raw_data</span><span class="p">,</span><span class="no">/datasets/dataset1</span><span class="p">,</span><span class="kd">dataset1_measurement1.cbf.gz</span>
</pre></div>
</div>
</div>
<p>Notice that <code class="docutils literal notranslate"><span class="pre">dataset1_measurement1.cbf.gz</span></code> is not the same as the first image filename
(<code class="docutils literal notranslate"><span class="pre">dataset1_measurement1_00001.cbf.gz</span></code>), but rather the <code class="docutils literal notranslate"><span class="pre">dataset_name</span></code> and the file extension. This is enough to
determine the first image by performing a GLOB search for <code class="docutils literal notranslate"><span class="pre">{dataset_name}*{file_extension}</span></code> within
<code class="docutils literal notranslate"><span class="pre">{raw_data_dir}/{dataset_dir}</span></code>. The first alphabetically sorted result will be considered as the first image.</p>
</section>
</section>
<section id="job-execution">
<h3>Job execution<a class="headerlink" href="#job-execution" title="Link to this heading">#</a></h3>
<p>For each dataset to be processed, <code class="docutils literal notranslate"><span class="pre">xtl.autoproc</span></code> will create a job. A job is a subprocess that runs autoPROC in the
background. To better organize the autoPROC runs, we have opted to include the input to autoPROC in a <code class="docutils literal notranslate"><span class="pre">.dat</span></code> macro
file, which is in turn passed to the autoPROC <code class="docutils literal notranslate"><span class="pre">process</span></code> command, via an intermediate shell script.</p>
<p>Once a job is launched, the job directory is first created within <code class="docutils literal notranslate"><span class="pre">{output_dir}/{dataset_dir}</span></code>, typically in the form
of <code class="docutils literal notranslate"><span class="pre">autoproc_runXX</span></code>, and then the macro file and shell script are created within that directory. A typical shell
script and macro file will look like this:</p>
<div class="literal-block-wrapper docutils container" id="id12">
<div class="code-block-caption"><span class="caption-text"><code class="docutils literal notranslate"><span class="pre">xtl_autoPROC.sh</span></code></span><a class="headerlink" href="#id12" title="Link to this code">#</a></div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>
process<span class="w"> </span>-M<span class="w"> </span>/path/to/processed/datasets/dataset1/autoproc_run01/xtl_autoPROC.dat<span class="w"> </span>-d<span class="w"> </span>/path/to/processed/datasets/dataset1/autoproc_run01/autoproc
</pre></div>
</div>
</div>
<div class="literal-block-wrapper docutils container" id="id13">
<div class="code-block-caption"><span class="caption-text"><code class="docutils literal notranslate"><span class="pre">xtl_autoPROC.dat</span></code></span><a class="headerlink" href="#id13" title="Link to this code">#</a></div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># autoPROC macro file</span>
<span class="c1"># Generated by xtl v.0.1.0 on 2025-12-30T19:47:35.620825</span>
<span class="c1">#  user@host [distro]</span>

<span class="c1">### Dataset definitions</span>
<span class="c1"># autoproc_id = xtl7156</span>
<span class="c1"># no_sweeps = 1</span>
<span class="c1">## Sweep 1 [xtl7156]: dataset1_measurement1</span>
<span class="c1">#   raw_data = /path/to/raw_data/datasets/dataset1/</span>
<span class="c1">#   first_image = dataset1_measurement1_00001.cbf.gz</span>
<span class="c1">#   image_template = dataset1_measurement1_#####.cbf.gz</span>
<span class="c1">#   img_no_first = 1</span>
<span class="c1">#   img_no_last = 3600</span>
<span class="c1">#   idn = xtl7156,/path/to/raw_data/datasets/dataset1/,dataset1_measurement1_#####.cbf.gz,1,3600</span>

<span class="c1">### CLI arguments (including dataset definitions and macros)</span>
<span class="n">__args</span><span class="o">=</span><span class="s1">&#39;-Id &quot;xtl7156,/path/to/raw_data/datasets/dataset1/,dataset1_measurement1_#####.cbf.gz,1,3600&quot; -B -M HighResCutOnCChalf&#39;</span>

<span class="c1">### User parameters</span>
<span class="n">cell</span><span class="o">=</span><span class="s2">&quot;79.0 79.0 37.0 90.0 90.0 90.0&quot;</span>
<span class="n">symm</span><span class="o">=</span><span class="s2">&quot;P43212&quot;</span>
<span class="n">nres</span><span class="o">=</span><span class="mi">129</span>

<span class="c1">### XDS parameters</span>
<span class="n">autoPROC_XdsKeyword_MAXIMUM_NUMBER_OF_JOBS</span><span class="o">=</span><span class="mi">16</span>
<span class="n">autoPROC_XdsKeyword_MAXIMUM_NUMBER_OF_PROCESSORS</span><span class="o">=</span><span class="mi">4</span>
<span class="o">...</span>
</pre></div>
</div>
</div>
<p>As you can see, the <code class="docutils literal notranslate"><span class="pre">xtl_autoPROC.sh</span></code> runs the autoPROC <code class="docutils literal notranslate"><span class="pre">process</span></code> command by passing the <code class="docutils literal notranslate"><span class="pre">xtl_autoPROC.dat</span></code> macro
file as input and the output directory for the autoPROC run. In turn, the macro file contains the rest of the autoPROC
parameters, as well as some debug information for the dataset discovery process of <code class="docutils literal notranslate"><span class="pre">xtl.autoproc</span></code>.</p>
<p>When the <code class="docutils literal notranslate"><span class="pre">xtl_autoPROC.sh</span></code> script is executed as a subprocess, its standard output and error streams (and subsequently
those of the autoPROC <code class="docutils literal notranslate"><span class="pre">process</span></code> command) are redirected to <code class="docutils literal notranslate"><span class="pre">xtl_autoPROC.stdout.log</span></code> and
<code class="docutils literal notranslate"><span class="pre">xtl_autoPROC.stderr.log</span></code>, respectively, withing the job directory.</p>
<p>The jobs are executed asynchronously, and the main event loop ensures that only a certain number of jobs are running
simultaneously (controlled by the <code class="docutils literal notranslate"><span class="pre">--no-jobs</span></code> option, default: <code class="docutils literal notranslate"><span class="pre">1</span></code>).</p>
</section>
<section id="post-completion-tidy-up">
<h3>Post-completion tidy-up<a class="headerlink" href="#post-completion-tidy-up" title="Link to this heading">#</a></h3>
<p>Once the autoPROC <code class="docutils literal notranslate"><span class="pre">process</span></code> command exits, a few tidy-up tasks are triggered. First, <code class="docutils literal notranslate"><span class="pre">xtl.autoproc</span></code> will try to
determine if the autoPROC run was successful (<em>i.e.</em> whether it yielded a reflection file), by checking for the presence
of the <code class="docutils literal notranslate"><span class="pre">staraniso_alldata-unique.mtz</span></code> file. It then copies the following files from the autoPROC output directory to
the job directory, for easier access:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">summary.html</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">report.pdf</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">report_staraniso.pdf</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">truncate-unique.mtz</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">staraniso_alldata-unique.mtz</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">xtlXXXX.dat</span></code></p></li>
</ul>
<p>The <code class="docutils literal notranslate"><span class="pre">xtlXXXX.dat</span></code> file contains all the parameters that autoPROC digested from the user’s input. The two MTZ files
will be prepended with the <code class="docutils literal notranslate"><span class="pre">dataset_name</span></code>.</p>
<p>Finally, if the autoPROC run was deemed successful, an <code class="docutils literal notranslate"><span class="pre">xtl_autoPROC.json</span></code> file will also be generated within the job
directory. This JSON file combines results from <code class="docutils literal notranslate"><span class="pre">imginfo.xml</span></code>, <code class="docutils literal notranslate"><span class="pre">truncate.xml</span></code>, <code class="docutils literal notranslate"><span class="pre">staraniso.xml</span></code> and <code class="docutils literal notranslate"><span class="pre">CORRECT.LP</span></code>,
and can be very convenient for downstream programmatic parsing of autoPROC results. A little jiffy
(<code class="docutils literal notranslate"><span class="pre">xtl.autoproc</span> <span class="pre">json2csv</span></code>) is provided to convert the JSON files from all jobs into a single monolithic CSV file, that
may or may not be more convenient to work with than the individual JSON files.</p>
</section>
<section id="advanced-parametrization">
<h3>Advanced parametrization<a class="headerlink" href="#advanced-parametrization" title="Link to this heading">#</a></h3>
<p>Although <code class="docutils literal notranslate"><span class="pre">xtl.autoproc</span></code> includes options for the most frequently used autoPROC parameters, sometimes it may not be
enough. To ensure that any possible autoPROC configuration can be launched within the provided framework, any arbitrary
parameter can be passed along to autoPROC using one of two ways.</p>
<p>On a global level, using the <code class="docutils literal notranslate"><span class="pre">-x</span></code>/<code class="docutils literal notranslate"><span class="pre">--extra</span></code> option will pass a single <code class="docutils literal notranslate"><span class="pre">parameter=value</span></code> pair. If more than one
parameter need to be passed along, then the <code class="docutils literal notranslate"><span class="pre">-x</span></code> option can be provided multiple times, <em>e.g.</em>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>xtl.autoproc<span class="w"> </span>process<span class="w"> </span>datasets.csv<span class="w"> </span>-x<span class="w"> </span><span class="nv">autoPROC_XdsIntegPostrefNumCycle</span><span class="o">=</span><span class="m">5</span><span class="w"> </span>-x<span class="w"> </span><span class="nv">wave</span><span class="o">=</span><span class="m">0</span>.9876
</pre></div>
</div>
<p>On a dataset level, the same can be achieved by specifying an <code class="docutils literal notranslate"><span class="pre">extra_params</span></code> column, which expects a
semicolon-separated list of <code class="docutils literal notranslate"><span class="pre">parameter=value</span></code> pairs, <em>e.g.</em>:</p>
<div class="literal-block-wrapper docutils container" id="id14">
<div class="code-block-caption"><span class="caption-text"><code class="docutils literal notranslate"><span class="pre">datasets.csv</span></code></span><a class="headerlink" href="#id14" title="Link to this code">#</a></div>
<div class="highlight-csv notranslate"><div class="highlight"><pre><span></span><span class="o"># first_image</span><span class="p">,</span><span class="no">extra_params</span>
<span class="o">/path/to/dataset1/dataset1_00001.cbf.gz</span><span class="p">,</span><span class="no">autoPROC_XdsIntegPostrefNumCycle=5;wave=0.9876</span>
<span class="o">/path/to/dataset2/dataset2_00001.cbf.gz</span><span class="p">,</span><span class="no">wave=0.9876</span>
</pre></div>
</div>
</div>
<p>Internally, the provided arguments will be converted into a <code class="docutils literal notranslate"><span class="pre">{parameter:</span> <span class="pre">value}</span></code> dictionary by splitting on the <code class="docutils literal notranslate"><span class="pre">=</span></code>
character, and then try to apply proper character escaping to the value, <em>e.g.</em> padding with double quotes if it
contains any spaces, before passing it to the autoPROC command. However, do note that no checks will be performed on the
parameter names to ensure that they are valid autoPROC parameters. This responsibility falls on the user. A list of all
the supported autoPROC parameters can be found <a class="reference external" href="https://www.globalphasing.com/autoproc/manual/appendix1.html">here</a>.</p>
</section>
</section>
</section>


                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="index.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Command line utilities</p>
      </div>
    </a>
    <a class="right-next"
       href="../api/modules.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">API documentation</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#prerequisites">Prerequisites</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#process-command"><code class="docutils literal notranslate"><span class="pre">process</span></code> command</a><ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#a-few-examples">A few examples</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#unit-cell-space-group">Unit-cell &amp; space group</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#reference-mtz-file">Reference MTZ file</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#resolution-cutoff">Resolution cutoff</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#anomalous-signal">Anomalous signal</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#ice-rings">Ice rings</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#beamline-macros">Beamline macros</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#dataset-merging">Dataset merging</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#output-directory">Output directory</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#parallelization">Parallelization</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#process-wf-command"><code class="docutils literal notranslate"><span class="pre">process_wf</span></code> command</a><ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#updating-nml-files">Updating NML files</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#options-command"><code class="docutils literal notranslate"><span class="pre">options</span></code> command</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#csv-specification">CSV specification</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#technical-documentation">Technical documentation</a><ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#dataset-discovery">Dataset discovery</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#dataset-name-determination">Dataset name determination</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#job-execution">Job execution</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#post-completion-tidy-up">Post-completion tidy-up</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#advanced-parametrization">Advanced parametrization</a></li>
</ul>
</li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Dimitris P. Triandafillidis
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2020-2025, Dimitris P. Triandafillidis.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>